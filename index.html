<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Banking Software</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f9;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            text-align: center;
        }

        h1, h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
        }

        button {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        .hidden {
            display: none;
        }

        .message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        /* Profile Styles */
        .profile-card {
            background-color: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: left;
        }
        .profile-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ced4da;
        }
        .profile-item:last-child {
            border-bottom: none;
        }
        .profile-label {
            font-weight: bold;
            color: #555;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="login-screen">
        <h1>Welcome to E-Banking</h1>
        <h2>Admin Login</h2>
        <form id="admin-login-form">
            <input type="text" id="admin-id" placeholder="Admin ID" required>
            <input type="password" id="admin-password" placeholder="Password" required>
            <button type="submit">Admin Login</button>
        </form>

        <h2>User Login</h2>
        <form id="user-login-form">
            <input type="text" id="user-account" placeholder="Account Number" required>
            <input type="password" id="user-pin" placeholder="Security PIN" required>
            <button type="submit">User Login</button>
        </form>
        <p class="message" id="login-message"></p>
    </div>

    <div id="admin-dashboard" class="hidden">
        <h1>Admin Dashboard</h1>
        <button onclick="showCreateAccountForm()">Create New Account</button>
        <button onclick="showTransactionsReport()">View Transactions Report</button>
        <button onclick="showAdminProfileSearch()">Search Profiles</button>
        <button onclick="logout()">Logout</button>
        
        <div id="create-account-form" class="hidden">
            <h2>Create Account</h2>
            <form id="new-account-form">
                <input type="text" id="cust-name" placeholder="Customer Name" required>
                <input type="tel" id="cust-mobile" placeholder="Mobile Number" required>
                <input type="date" id="cust-dob" required>
                <input type="text" id="cust-address" placeholder="Address" required>
                <input type="text" id="cust-adhar" placeholder="Aadhar Number" required>
                <button type="submit">Create Account</button>
            </form>
            <p class="message" id="admin-message"></p>
        </div>

        <div id="transactions-report" class="hidden">
            <h2>Transactions Report</h2>
            <form id="report-form">
                <input type="text" id="report-account" placeholder="Account Number (optional)">
                <input type="date" id="report-start-date">
                <input type="date" id="report-end-date">
                <button type="submit">Generate Report</button>
            </form>
            <table id="transactions-table">
                <thead>
                    <tr>
                        <th>Account</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <p class="message" id="report-message"></p>
        </div>

        <div id="admin-profile-search" class="hidden">
            <h2>Search Customer Profile</h2>
            <form id="profile-search-form">
                <input type="text" id="search-account" placeholder="Enter Account Number" required>
                <button type="submit">Search</button>
            </form>
            <div id="admin-profile-view" class="profile-card hidden">
                <h3>Customer Profile</h3>
                <div class="profile-item"><span class="profile-label">Name:</span> <span id="admin-profile-name"></span></div>
                <div class="profile-item"><span class="profile-label">Account Number:</span> <span id="admin-profile-acc"></span></div>
                <div class="profile-item"><span class="profile-label">Security PIN:</span> <span id="admin-profile-pin"></span></div>
                <div class="profile-item"><span class="profile-label">Mobile Number:</span> <span id="admin-profile-mobile"></span></div>
                <div class="profile-item"><span class="profile-label">Date of Birth:</span> <span id="admin-profile-dob"></span></div>
                <div class="profile-item"><span class="profile-label">Age:</span> <span id="admin-profile-age"></span></div>
                <div class="profile-item"><span class="profile-label">Aadhar Number:</span> <span id="admin-profile-adhar"></span></div>
                <div class="profile-item"><span class="profile-label">Address:</span> <span id="admin-profile-address"></span></div>
            </div>
            <p class="message" id="profile-message"></p>
        </div>
    </div>

    <div id="user-dashboard" class="hidden">
        <h1>User Dashboard</h1>
        <p>Welcome, <strong id="user-name"></strong>!</p>
        <p>Account Number: <strong id="user-acc-num"></strong></p>
        <button onclick="showUserProfile()">View Profile</button>
        <button onclick="checkBalance()">Check Balance</button>
        <button onclick="showTransferForm()">Transfer Money</button>
        <button onclick="showWithdrawForm()">Withdraw</button>
        <button onclick="logout()">Logout</button>

        <div id="user-profile-view" class="profile-card">
            <h3>My Profile</h3>
            <div class="profile-item"><span class="profile-label">Name:</span> <span id="user-profile-name"></span></div>
            <div class="profile-item"><span class="profile-label">Account Number:</span> <span id="user-profile-acc"></span></div>
            <div class="profile-item"><span class="profile-label">Security PIN:</span> <span id="user-profile-pin"></span></div>
            <div class="profile-item"><span class="profile-label">Mobile Number:</span> <span id="user-profile-mobile"></span></div>
            <div class="profile-item"><span class="profile-label">Date of Birth:</span> <span id="user-profile-dob"></span></div>
            <div class="profile-item"><span class="profile-label">Age:</span> <span id="user-profile-age"></span></div>
            <div class="profile-item"><span class="profile-label">Aadhar Number:</span> <span id="user-profile-adhar"></span></div>
            <div class="profile-item"><span class="profile-label">Address:</span> <span id="user-profile-address"></span></div>
        </div>

        <div id="balance-section" class="hidden">
            <h2>Account Balance: $<span id="current-balance"></span></h2>
        </div>

        <div id="transfer-form" class="hidden">
            <h2>Transfer Money</h2>
            <form id="transfer-money-form">
                <input type="text" id="receiver-account" placeholder="Receiver's Account Number" required>
                <input type="number" id="transfer-amount" placeholder="Amount" required min="1">
                <button type="submit">Transfer</button>
            </form>
        </div>

        <div id="withdraw-form" class="hidden">
            <h2>Withdraw</h2>
            <form id="withdraw-money-form">
                <input type="number" id="withdraw-amount" placeholder="Amount" required min="1">
                <button type="submit">Withdraw</button>
            </form>
        </div>
        <p class="message" id="user-message"></p>
    </div>

</div>

<script>
    // --- DATABASE SETUP (IndexedDB) ---
    let db;
    const DB_NAME = 'eBankingDB';
    const DB_VERSION = 1;

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = (event) => {
                console.error('Error opening database:', event.target.error);
                reject('Database error');
            };

            request.onupgradeneeded = (event) => {
                db = event.target.result;
                if (!db.objectStoreNames.contains('customers')) {
                    const customerStore = db.createObjectStore('customers', { keyPath: 'accountNumber' });
                    customerStore.createIndex('mobile', 'mobile', { unique: true });
                }
                if (!db.objectStoreNames.contains('transactions')) {
                    const transactionStore = db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                    transactionStore.createIndex('accountNumber', 'accountNumber');
                    transactionStore.createIndex('date', 'date');
                }
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                resolve(db);
            };
        });
    }

    // --- APPLICATION STATE & UI MANAGEMENT ---
    let currentLoggedInUser = null;
    const screens = {
        login: document.getElementById('login-screen'),
        admin: document.getElementById('admin-dashboard'),
        user: document.getElementById('user-dashboard')
    };
    const adminForms = {
        createAccount: document.getElementById('create-account-form'),
        report: document.getElementById('transactions-report'),
        profileSearch: document.getElementById('admin-profile-search')
    };
    const userForms = {
        profile: document.getElementById('user-profile-view'),
        balance: document.getElementById('balance-section'),
        transfer: document.getElementById('transfer-form'),
        withdraw: document.getElementById('withdraw-form')
    };

    function showScreen(screen) {
        Object.values(screens).forEach(s => s.classList.add('hidden'));
        screens[screen].classList.remove('hidden');
        if (screen === 'admin') {
            showCreateAccountForm();
        }
        if (screen === 'user') {
            showUserProfile();
        }
    }

    function showAdminMessage(message, type) {
        const msgElem = document.getElementById('admin-message');
        msgElem.textContent = message;
        msgElem.className = `message ${type}`;
    }

    function showUserMessage(message, type) {
        const msgElem = document.getElementById('user-message');
        msgElem.textContent = message;
        msgElem.className = `message ${type}`;
    }

    function clearAdminForms() {
        Object.values(adminForms).forEach(f => f.classList.add('hidden'));
    }

    function clearUserForms() {
        Object.values(userForms).forEach(f => f.classList.add('hidden'));
    }

    function showCreateAccountForm() {
        clearAdminForms();
        adminForms.createAccount.classList.remove('hidden');
    }

    function showTransactionsReport() {
        clearAdminForms();
        adminForms.report.classList.remove('hidden');
    }

    function showAdminProfileSearch() {
        clearAdminForms();
        document.getElementById('admin-profile-view').classList.add('hidden');
        adminForms.profileSearch.classList.remove('hidden');
    }
    
    function showUserProfile() {
        clearUserForms();
        userForms.profile.classList.remove('hidden');
        renderProfile(currentLoggedInUser, 'user');
    }

    function showTransferForm() {
        clearUserForms();
        userForms.transfer.classList.remove('hidden');
    }
    
    function showWithdrawForm() {
        clearUserForms();
        userForms.withdraw.classList.remove('hidden');
    }

    // Helper function to calculate age from DOB
    function calculateAge(dob) {
        const birthDate = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        return age;
    }

    // New function to render profile data
    function renderProfile(customer, dashboardType) {
        const prefix = dashboardType === 'admin' ? 'admin-' : 'user-';
        document.getElementById(`${prefix}profile-name`).textContent = customer.name;
        document.getElementById(`${prefix}profile-acc`).textContent = customer.accountNumber;
        document.getElementById(`${prefix}profile-pin`).textContent = customer.securityPin;
        document.getElementById(`${prefix}profile-mobile`).textContent = customer.mobile;
        document.getElementById(`${prefix}profile-dob`).textContent = customer.dob;
        document.getElementById(`${prefix}profile-age`).textContent = calculateAge(customer.dob);
        document.getElementById(`${prefix}profile-adhar`).textContent = customer.adhar;
        document.getElementById(`${prefix}profile-address`).textContent = customer.address;
        document.getElementById(`${prefix}profile-view`).classList.remove('hidden');
    }


    // --- ADMIN LOGIC ---
    // The credentials are now hidden within the JavaScript and not in the HTML placeholder.
    const adminUser = {
        id: 'admin',
        password: 'a123'
    };

    document.getElementById('admin-login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('admin-id').value;
        const password = document.getElementById('admin-password').value;
        if (id === adminUser.id && password === adminUser.password) {
            showScreen('admin');
        } else {
            document.getElementById('login-message').textContent = 'Invalid admin credentials.';
            document.getElementById('login-message').className = 'message error';
        }
    });

    document.getElementById('new-account-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const customerData = {
            name: document.getElementById('cust-name').value,
            mobile: document.getElementById('cust-mobile').value,
            dob: document.getElementById('cust-dob').value,
            address: document.getElementById('cust-address').value,
            adhar: document.getElementById('cust-adhar').value
        };
        try {
            const newCustomer = await createAccount(customerData);
            showAdminMessage(`Account created for ${newCustomer.name}. Acc #: ${newCustomer.accountNumber}, PIN: ${newCustomer.securityPin}`, 'success');
            document.getElementById('new-account-form').reset();
        } catch (error) {
            showAdminMessage(error, 'error');
        }
    });

    document.getElementById('report-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const accountNumber = document.getElementById('report-account').value;
        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;

        try {
            const transactions = await viewTransactions(accountNumber, startDate, endDate);
            renderTransactionsTable(transactions);
            showAdminMessage(`Found ${transactions.length} transactions.`, 'success');
        } catch (error) {
            showAdminMessage('Failed to fetch transactions.', 'error');
        }
    });

    document.getElementById('profile-search-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const accountNumber = document.getElementById('search-account').value;
        try {
            const customer = await findCustomerByAccount(accountNumber);
            renderProfile(customer, 'admin');
            document.getElementById('profile-message').textContent = '';
        } catch (error) {
            document.getElementById('admin-profile-view').classList.add('hidden');
            document.getElementById('profile-message').textContent = 'Customer not found.';
            document.getElementById('profile-message').className = 'message error';
        }
    });

    // --- USER LOGIC ---
    document.getElementById('user-login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const accountNumber = document.getElementById('user-account').value;
        const securityPin = document.getElementById('user-pin').value;
        try {
            const user = await userLogin(accountNumber, securityPin);
            currentLoggedInUser = user;
            document.getElementById('user-name').textContent = user.name;
            document.getElementById('user-acc-num').textContent = user.accountNumber;
            showScreen('user');
        } catch (error) {
            document.getElementById('login-message').textContent = 'Invalid account number or PIN.';
            document.getElementById('login-message').className = 'message error';
        }
    });

    async function checkBalance() {
        try {
            const balance = await getUserBalance(currentLoggedInUser.accountNumber);
            document.getElementById('current-balance').textContent = balance.toFixed(2);
            clearUserForms();
            userForms.balance.classList.remove('hidden');
        } catch (error) {
            showUserMessage('Failed to retrieve balance.', 'error');
        }
    }

    document.getElementById('transfer-money-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const receiverAcc = document.getElementById('receiver-account').value;
        const amount = parseFloat(document.getElementById('transfer-amount').value);
        if (isNaN(amount) || amount <= 0) {
            showUserMessage('Please enter a valid amount.', 'error');
            return;
        }
        try {
            await transferMoney(currentLoggedInUser.accountNumber, receiverAcc, amount);
            showUserMessage('Money transferred successfully.', 'success');
            document.getElementById('transfer-money-form').reset();
            checkBalance();
        } catch (error) {
            showUserMessage(error, 'error');
        }
    });

    document.getElementById('withdraw-money-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const amount = parseFloat(document.getElementById('withdraw-amount').value);
        if (isNaN(amount) || amount <= 0) {
            showUserMessage('Please enter a valid amount.', 'error');
            return;
        }
        try {
            await withdrawMoney(currentLoggedInUser.accountNumber, amount);
            showUserMessage('Withdrawal successful.', 'success');
            document.getElementById('withdraw-money-form').reset();
            checkBalance();
        } catch (error) {
            showUserMessage(error, 'error');
        }
    });
    
    // --- CORE DATABASE FUNCTIONS ---
    async function createAccount(customerData) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['customers'], 'readwrite');
            const store = transaction.objectStore('customers');
            const accountNumber = 'ACC' + Math.floor(10000000 + Math.random() * 90000000);
            const securityPin = Math.floor(1000 + Math.random() * 9000).toString();
            const customer = {
                ...customerData,
                accountNumber,
                securityPin,
                balance: 0,
                creationDate: new Date().toISOString()
            };
            const request = store.add(customer);
            request.onsuccess = () => resolve(customer);
            request.onerror = () => reject('Error creating account. Mobile number or Aadhar might already exist.');
        });
    }

    async function userLogin(accountNumber, securityPin) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['customers'], 'readonly');
            const store = transaction.objectStore('customers');
            const request = store.get(accountNumber);
            request.onsuccess = (event) => {
                const customer = event.target.result;
                if (customer && customer.securityPin === securityPin) {
                    resolve(customer);
                } else {
                    reject('Invalid account number or PIN');
                }
            };
            request.onerror = () => reject('Error during login');
        });
    }
    
    async function findCustomerByAccount(accountNumber) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['customers'], 'readonly');
            const store = transaction.objectStore('customers');
            const request = store.get(accountNumber);
            request.onsuccess = (event) => {
                const customer = event.target.result;
                if (customer) {
                    resolve(customer);
                } else {
                    reject('Customer not found');
                }
            };
            request.onerror = () => reject('Error fetching customer');
        });
    }

    async function transferMoney(senderAcc, receiverAcc, amount) {
        return new Promise((resolve, reject) => {
            if (senderAcc === receiverAcc) {
                reject('Cannot transfer to the same account.');
                return;
            }
            const transaction = db.transaction(['customers', 'transactions'], 'readwrite');
            const customerStore = transaction.objectStore('customers');
            const transactionStore = transaction.objectStore('transactions');
            
            const senderReq = customerStore.get(senderAcc);
            const receiverReq = customerStore.get(receiverAcc);
            
            senderReq.onsuccess = () => {
                const sender = senderReq.result;
                if (!sender || sender.balance < amount) {
                    reject('Insufficient funds or invalid sender account.');
                    return;
                }
                
                receiverReq.onsuccess = () => {
                    const receiver = receiverReq.result;
                    if (!receiver) {
                        reject('Receiver account not found.');
                        return;
                    }
                    
                    sender.balance -= amount;
                    receiver.balance += amount;

                    const updateSenderReq = customerStore.put(sender);
                    const updateReceiverReq = customerStore.put(receiver);

                    updateSenderReq.onsuccess = updateReceiverReq.onsuccess = () => {
                        const transferDate = new Date().toISOString();
                        transactionStore.add({ accountNumber: sender.accountNumber, type: 'debit', amount: amount, date: transferDate, details: `Transfer to ${receiver.accountNumber}` });
                        transactionStore.add({ accountNumber: receiver.accountNumber, type: 'credit', amount: amount, date: transferDate, details: `Transfer from ${sender.accountNumber}` });
                        resolve('Transfer successful.');
                    };
                };
            };
            transaction.onerror = () => reject('Transaction error');
        });
    }

    async function withdrawMoney(accountNumber, amount) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['customers', 'transactions'], 'readwrite');
            const customerStore = transaction.objectStore('customers');
            const transactionStore = transaction.objectStore('transactions');

            const customerReq = customerStore.get(accountNumber);
            customerReq.onsuccess = () => {
                const customer = customerReq.result;
                if (!customer || customer.balance < amount) {
                    reject('Insufficient funds.');
                    return;
                }
                customer.balance -= amount;
                const updateReq = customerStore.put(customer);
                updateReq.onsuccess = () => {
                    const withdrawalDate = new Date().toISOString();
                    const txn = {
                        accountNumber: customer.accountNumber,
                        type: 'debit',
                        amount: amount,
                        date: withdrawalDate,
                        details: 'Cash Withdrawal'
                    };
                    transactionStore.add(txn);
                    resolve('Withdrawal successful.');
                };
            };
            transaction.onerror = () => reject('Transaction error');
        });
    }

    async function getUserBalance(accountNumber) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['customers'], 'readonly');
            const store = transaction.objectStore('customers');
            const request = store.get(accountNumber);
            request.onsuccess = (event) => {
                const customer = event.target.result;
                if (customer) {
                    resolve(customer.balance);
                } else {
                    reject('Account not found');
                }
            };
            request.onerror = () => reject('Error retrieving balance');
        });
    }

    async function viewTransactions(accountNumber, startDate, endDate) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['transactions'], 'readonly');
            const store = transaction.objectStore('transactions');
            const index = store.index('accountNumber');
            const allTransactions = [];
            const range = accountNumber ? IDBKeyRange.only(accountNumber) : null;
            
            const request = index.openCursor(range, 'prev');
            if (!accountNumber) {
                const requestAll = store.openCursor(null, 'prev');
                requestAll.onsuccess = (event) => {
                    let cursor = event.target.result;
                    if (cursor) {
                        allTransactions.push(cursor.value);
                        cursor.continue();
                    } else {
                        filterAndResolveTransactions(allTransactions, startDate, endDate, resolve);
                    }
                };
                requestAll.onerror = () => reject('Failed to fetch all transactions.');
            } else {
                request.onsuccess = (event) => {
                    let cursor = event.target.result;
                    if (cursor) {
                        allTransactions.push(cursor.value);
                        cursor.continue();
                    } else {
                        filterAndResolveTransactions(allTransactions, startDate, endDate, resolve);
                    }
                };
                request.onerror = () => reject('Failed to fetch transactions for account.');
            }
        });
    }

    function filterAndResolveTransactions(transactions, startDate, endDate, resolve) {
        const filteredTransactions = transactions.filter(txn => {
            const txnDate = new Date(txn.date);
            const start = startDate ? new Date(startDate) : null;
            const end = endDate ? new Date(endDate) : null;
            return (!start || txnDate >= start) && (!end || txnDate <= end);
        });
        resolve(filteredTransactions);
    }

    function renderTransactionsTable(transactions) {
        const tableBody = document.querySelector('#transactions-table tbody');
        tableBody.innerHTML = '';
        if (transactions.length === 0) {
            const row = tableBody.insertRow();
            const cell = row.insertCell(0);
            cell.textContent = 'No transactions found.';
            cell.colSpan = 5;
            return;
        }
        transactions.forEach(txn => {
            const row = tableBody.insertRow();
            row.insertCell(0).textContent = txn.accountNumber;
            row.insertCell(1).textContent = txn.type;
            row.insertCell(2).textContent = `$${txn.amount.toFixed(2)}`;
            row.insertCell(3).textContent = new Date(txn.date).toLocaleString();
            row.insertCell(4).textContent = txn.details;
        });
    }

    function logout() {
        currentLoggedInUser = null;
        showScreen('login');
        document.getElementById('login-message').textContent = '';
        document.getElementById('admin-login-form').reset();
        document.getElementById('user-login-form').reset();
    }

    // Initialize the application
    openDB().then(() => {
        console.log('Database initialized.');
    }).catch(console.error);
</script>

</body>
</html>
